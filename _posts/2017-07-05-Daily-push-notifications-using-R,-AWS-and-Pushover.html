---
layout: post
title:  "Daily push notifications using R, AWS and Pushover"
date:   2017-07-05
---
<meta charset="UTF-8">

My girlfriend and I are in the midst of buying a house, hence we need to take out a mortage - preferably at the best possible price. Therefore I want to keep myself updated on the current price of the mortage we are eyeing in order to strike when the price is just right.

<br>
<br>

To my surprise I was unsuccesful in finding any kind of service that would shoot a daily notification to me containing the current mortage price (Well, I wanted to test out a solution in R, so i didn't bother looking THAT hard for suitable service). So that's what I'm trying to achieve and describe in this post!

<br>
<br>

The tools needed are:

<br>

<ul>
  <li>R and Rstudio</li>
  <li>Amazon Web Services (AWS)</li>
  <li>MobaXterm</li>
  <li>Pushover.net API</li>
</ul>

I have Rstudio set up on a EC2 instance from AWS - I won't go over how to install Rstudio on a AWS instance, I followed <a target="_blank" href="http://blog.yhat.com/posts/r-in-the-cloud-part-1.html">this</a> and <a target="_blank" href="https://www.r-statistics.com/2015/06/setting-rstudio-server-using-amazon-web-services-aws-a-step-by-step-screenshots-tutorial/">this</a> tutorial and I suggest you do the same. The next step is to write a simple R script that scrapes a website for mortage prices and uses <a target="_blank" href="https://pushover.net/">Pushovers</a> API to send out a notification and then schedule this script to run daily. MobaXterm is used to remotely access the virtual linux machine and set a cron job to run the R script daily.

<br>
<br>

The mortage price is scraped from Sydbanks website and I use SelectorGadget (a Google Chrome add-in) to identify precisely the CSS selector of interest. In this case it is the current sales price (td:nth-child(3)) and the point-change (td:nth-child(7)) since yesterday. The CSS selector are then fed to html_node() and html_text() functions from the rvest package which graps the price and point-change and store them as a string.

<pre style="background-color:#2c6b46;color:white;font-size:13px;">
  #################################### BASICS #############################################

  # Author: Mads Bønding
  # Date:05-07-2017
  # Document version: 1.0
  # R version: 3.4.0 sessionInfo()
  # R Studio: 1.0.143
  # Purpose: Scrape mortage prices and send a daily push notification with current price to my phone/watch using R, AWS and Pushover.


  ################################## LIBRARIES ############################################
  library(dplyr) # v. 0.4.3
  library(rvest) # v. 0.3.2
  library(notifyR) # v. 1.02.0

  ################################# DATA WRANGLING ###########################################

  # read and store the url
  obl_2pct_uafdrag <- read_html("http://www.sydbank.dk/investering/analyser/obligationer/obligation?kode=DK0009504755&type=Obligation&sektor=NONE&straks=true")

  # Extract the relevent information from obl_2pct_uafdrag
  current_price <- obl_2pct_uafdrag %>%
    html_node("td:nth-child(3)") %>%
    html_text()

  daily_change <- obl_2pct_uafdrag %>%
    html_node("td:nth-child(7)") %>%
    html_text()

</pre>

<br>

Next step is putting together a message to send and actually sending it. I am using the send_push() function from Torben Engelmeyers  <a target="_blank" href="https://cran.r-project.org/web/packages/notifyR/index.html">notifyR</a> package to send myself a push notification. NotifyR uses the API from Pushover and we need to create an account on  <a target="_blank" href="https://pushover.net/">pushover.net</a> and copy the userkey to our script in order to use the send_push() function. Then use the paste() to construct the message containing current_price and daily_change and include the message in send_push().

<br>

<pre style="background-color:#2c6b46;color:white;font-size:13px;">
  userkey <- 'xxxxxxxxxxxxxxxxxxxxxxxxxx'

  message <- paste("Kursen på 2.pct uden afdrag er idag ",current_price, " og har ændret sig ", daily_change, " siden igår.")

  send_push(userkey, message, title = "2. pct uden afdrag")

</pre>

<br>
<br>

With the script sorted out the next step is to make it run daily on my AWS instance. For windows users there is neat little addin to Rstudio that easily lets you schedule your R scripts but since my EC2 instance is running an ubuntu server I need to use another method.
<br>
<br>
I need to start a SSH session in MobaXterm(or any other SSH client) and connect to the AWS instance and run the command <i>crontab -e</i>. This will open an editor that lets you specify when and which script you want to schedule.

<br>
<br>

<img src="https://raw.githubusercontent.com/madsboending/madsboending.github.io/master/assets/img/crontab_arrow.jpg" alt="crontab">

<br>
<br>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'madsboending';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
